name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Swift
      uses: swift-actions/setup-swift@v1
      with:
        swift-version: "6.1"
        
    - name: Cache Swift Package Manager
      uses: actions/cache@v3
      with:
        path: .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Resolve Swift Package dependencies
      run: swift package resolve
      
    - name: Build project
      run: swift build --configuration release
      
    - name: Run tests
      run: swift test
      
    - name: Check for compilation warnings
      run: swift build --configuration debug 2>&1 | tee build.log && ! grep -i warning build.log
      
    - name: Verify executable runs
      run: |
        swift build --configuration release
        timeout 5s .build/release/GhostSay --help || true
        echo "Build verification complete"

  code-quality:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Swift
      uses: swift-actions/setup-swift@v1
      with:
        swift-version: "6.1"
        
    - name: Install SwiftLint
      run: brew install swiftlint
      
    - name: Run SwiftLint
      run: swiftlint lint --strict
      continue-on-error: true
      
    - name: Check Swift format
      run: |
        swift-format --version || echo "swift-format not available, skipping format check"
      continue-on-error: true